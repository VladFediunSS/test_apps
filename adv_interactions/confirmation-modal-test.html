<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Decision Modal Test</title>
  <style>
    .overlay[hidden] { display: none; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center; }
    .modal { background: #fff; border: 1px solid #000; padding: 8px; }
  </style>
</head>
<body>

  <h1>confirmation-modal-test.html</h1>

  <button type="button" id="open" data-testid="open">Open modal</button>

  <div id="overlay" class="overlay" hidden aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="title">
      <p id="title"><strong>Decision modal</strong></p>
      <button type="button" id="cancel" data-testid="cancel">Cancel</button>
      <button type="button" id="confirm" data-testid="confirm">Confirm</button>
    </div>
  </div>

  <p id="result" data-testid="result">Result: no action</p>

  <script>
    const openBtn = document.getElementById("open");
    const overlay = document.getElementById("overlay");
    const cancelBtn = document.getElementById("cancel");
    const confirmBtn = document.getElementById("confirm");
    const result = document.getElementById("result");
    let lastFocus = null;

    function focusables(container) {
      return Array.from(container.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'))
        .filter(el => !el.disabled && el.offsetParent !== null);
    }

    function trapTab(e) {
      if (e.key !== "Tab") return;
      const items = focusables(overlay);
      if (!items.length) return;
      const first = items[0];
      const last = items[items.length - 1];

      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    }

    function openModal() {
      lastFocus = document.activeElement;
      overlay.hidden = false;
      overlay.setAttribute("aria-hidden", "false");
      cancelBtn.focus();
      result.textContent = "Result: decision modal opened";
    }

    function closeModal(reason) {
      overlay.hidden = true;
      overlay.setAttribute("aria-hidden", "true");
      result.textContent = "Result: decision modal closed (" + reason + ")";
      if (lastFocus) lastFocus.focus();
    }

    openBtn.addEventListener("click", openModal);

    cancelBtn.addEventListener("click", () => closeModal("Cancel"));
    confirmBtn.addEventListener("click", () => closeModal("Confirm"));

    overlay.addEventListener("keydown", (e) => {
      trapTab(e);

      if (e.key === "Escape") {
        e.preventDefault();
        closeModal("Esc=Cancel");
      }

      if (e.key === "Enter") {
        e.preventDefault();
        closeModal("Enter=Confirm");
      }
    });
    // Blocking: outside click does nothing (no close handler)
  </script>

</body>
</html>
